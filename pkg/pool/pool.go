// Package pool предоставляет типобезопасный пул объектов с автоматическим сбросом состояния.
//
// Пул использует sync.Pool для переиспользования объектов и требует, чтобы они
// реализовывали метод Reset() для очистки состояния перед возвратом в пул.
package pool

import "sync"

// Resettable определяет интерфейс для объектов, которые могут сбрасывать своё состояние.
type Resettable interface {
	Reset()
}

// Pool — типобезопасный пул для переиспользования объектов с методом Reset().
//
// T — тип объектов в пуле, должен реализовывать интерфейс Resettable.
type Pool[T Resettable] struct {
	pool sync.Pool
	new  func() T
}

// New создаёт новый пул объектов с указанной функцией-конструктором.
//
// newFunc — функция для создания новых объектов, если пул пуст.
//
// Возвращает указатель на Pool.
func New[T Resettable](newFunc func() T) *Pool[T] {
	return &Pool[T]{
		pool: sync.Pool{
			New: func() interface{} {
				return newFunc()
			},
		},
		new: newFunc,
	}
}

// Get получает объект из пула или создаёт новый, если пул пуст.
//
// Возвращаемый объект готов к использованию.
func (p *Pool[T]) Get() T {
	return p.pool.Get().(T)
}

// Put помещает объект обратно в пул после сброса его состояния.
//
// obj — объект для возврата в пул.
//
// Автоматически вызывает Reset() перед помещением в пул.
func (p *Pool[T]) Put(obj T) {
	obj.Reset()
	p.pool.Put(obj)
}
